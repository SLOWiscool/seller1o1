<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mail Portal</title>
<style>
body { font-family: Arial; margin:20px; text-align:center; }
input, button, textarea { margin:5px; padding:8px; width:90%; max-width:400px; }
.hidden { display:none; }
</style>
</head>
<body>

<h1>Mail Portal</h1>

<!-- Login -->
<div id="login">
  <h2>Login</h2>
  <input id="email" type="email" placeholder="Email"><br>
  <input id="password" type="password" placeholder="Password"><br>
  <button onclick="login()">Login</button>
  <p id="login-msg"></p>
</div>

<!-- Always-visible buttons -->
<div id="buttons">
  <button onclick="showSupport()">Support</button>
  <button onclick="showAdminPrompt()">Admin Panel</button>
</div>

<!-- Dashboard -->
<div id="dashboard" class="hidden">
  <h2>Dashboard</h2>
  <button onclick="logout()">Logout</button>
  <hr>
  <input id="to" placeholder="Recipient Email"><br>
  <input id="subject" placeholder="Subject"><br>
  <textarea id="body" placeholder="Message"></textarea><br>
  <button onclick="sendEmail()">Send</button>
  <button onclick="replyEmail()">Reply</button>
  <button onclick="forwardEmail()">Forward</button>
  <p id="send-msg"></p>
</div>

<!-- Support -->
<div id="support" class="hidden">
  <h2>Support</h2>
  <p>Blank page for now</p>
  <button onclick="hideSupport()">Back</button>
</div>

<!-- Admin Panel -->
<div id="admin" class="hidden">
  <h2>Admin Panel</h2>
  <input id="newUsername" placeholder="Username"><br>
  <input id="newPass" type="password" placeholder="Password"><br>
  <button onclick="createAccount()">Create Account</button>
  <p id="admin-msg"></p>
</div>

<script>
let jwt="", currentEmail="";

async function login(){
  const email=document.getElementById("email").value;
  const password=document.getElementById("password").value;
  const res=await fetch("/api/send.js",{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({action:"login", email, password})
  });
  const data=await res.json();
  if(data.token){
    jwt=data.token;
    currentEmail=email;
    document.getElementById("login").classList.add("hidden");
    document.getElementById("dashboard").classList.remove("hidden");
    document.getElementById("login-msg").innerText="";
  } else {
    document.getElementById("login-msg").innerText=data.error||data["hydra:description"]||"Login failed";
  }
}

function logout(){
  jwt="";
  currentEmail="";
  document.getElementById("login").classList.remove("hidden");
  document.getElementById("dashboard").classList.add("hidden");
  document.getElementById("support").classList.add("hidden");
  document.getElementById("admin").classList.add("hidden");
}

function showSupport(){ document.getElementById("support").classList.remove("hidden"); }
function hideSupport(){ document.getElementById("support").classList.add("hidden"); }

function showAdminPrompt(){
  const code=prompt("Enter admin password:");
  if(code==="admin123"){
    document.getElementById("admin").classList.remove("hidden");
  } else alert("Wrong password!");
}

async function createAccount(){
  const username=document.getElementById("newUsername").value;
  const password=document.getElementById("newPass").value;
  const res=await fetch("/api/send.js",{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({action:"create", username, password})
  });
  const data=await res.json();
  document.getElementById("admin-msg").innerText=JSON.stringify(data);
}

async function sendEmail(){
  const to=document.getElementById("to").value;
  const subject=document.getElementById("subject").value;
  const body=document.getElementById("body").value;
  if(!jwt){ alert("Login first"); return; }
  const res=await fetch("/api/send.js",{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({action:"send", token:jwt, from:currentEmail, to, subject, body})
  });
  const data=await res.text();
  document.getElementById("send-msg").innerText=data;
}

async function replyEmail(){ alert("Reply feature placeholder"); }
async function forwardEmail(){ alert("Forward feature placeholder"); }
</script>
</body>
</html>
