<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TempMail Client</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #eee; text-align: center; }
    input, button { padding: 8px; margin: 6px; border-radius: 6px; border: none; }
    button { background: #444; color: #fff; cursor: pointer; }
    button:hover { background: #666; }
    #inbox { margin-top: 20px; text-align: left; max-width: 600px; margin-left:auto; margin-right:auto; }
    .msg { border: 1px solid #444; border-radius: 8px; padding: 10px; margin: 8px 0; background:#222; }
  </style>
</head>
<body>
  <h1>ðŸ“¨ Inbox</h1>

  <div id="auth">
    <h3>Create Account</h3>
    <input id="newUser" placeholder="Username">
    <input id="newPass" type="password" placeholder="Password">
    <button onclick="register()">Register</button>

    <h3>Login</h3>
    <input id="loginUser" placeholder="Username">
    <input id="loginPass" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
  </div>

  <div id="account" style="display:none;">
    <p>Logged in as: <span id="email"></span></p>
    <button onclick="loadInbox()">ðŸ”„ Refresh Inbox</button>
    <div id="inbox"></div>
  </div>

  <script>
    let token = null;
    let currentEmail = null;

    async function register() {
      const username = document.getElementById('newUser').value.trim();
      const password = document.getElementById('newPass').value.trim();
      if (!username || !password) return alert("Enter username + password");

      // âœ… Ask API to create a new account
      const res = await fetch("https://api.mail.tm/accounts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ address: username, password })
      });

      const data = await res.json();
      if (res.ok) {
        alert("Account created successfully!");
      } else {
        alert("Error: " + JSON.stringify(data));
      }
    }

    async function login() {
      const username = document.getElementById('loginUser').value.trim();
      const password = document.getElementById('loginPass').value.trim();

      const res = await fetch("https://api.mail.tm/token", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ address: username, password })
      });

      const data = await res.json();
      if (res.ok && data.token) {
        token = data.token;

        // âœ… Get account info to display actual email
        const accRes = await fetch("https://api.mail.tm/me", {
          headers: { "Authorization": "Bearer " + token }
        });
        const accData = await accRes.json();

        currentEmail = accData.address;
        document.getElementById("email").textContent = currentEmail;

        document.getElementById("auth").style.display = "none";
        document.getElementById("account").style.display = "block";

        loadInbox();
      } else {
        alert("Login failed: " + JSON.stringify(data));
      }
    }

    async function loadInbox() {
      if (!token) return;

      const res = await fetch("https://api.mail.tm/messages", {
        headers: { "Authorization": "Bearer " + token }
      });
      const data = await res.json();

      const inbox = document.getElementById("inbox");
      inbox.innerHTML = "";

      if (data["hydra:member"].length === 0) {
        inbox.innerHTML = "<p>No messages yet.</p>";
        return;
      }

      data["hydra:member"].forEach(msg => {
        const div = document.createElement("div");
        div.className = "msg";
        div.innerHTML = `<b>From:</b> ${msg.from.address}<br>
                         <b>Subject:</b> ${msg.subject}<br>
                         <b>Preview:</b> ${msg.intro}`;
        inbox.appendChild(div);
      });
    }
  </script>
</body>
</html>
